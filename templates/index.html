<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamics 365 Migration</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="styles.css"> <!-- Link to external styles.css -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.min.js"></script>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4">
        <h1 class="text-3xl font-bold text-center mb-8">Facillio.de ‚Üí Dynamics 365 Migration</h1>

        <!-- Authentication Form -->
        <div id="authForm" class="bg-white p-6 rounded-lg shadow-md max-w-md mx-auto">
            <div class="mb-4">
                <label for="email" class="block text-sm font-medium text-gray-700">Email:</label>
                <input type="email" id="email" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Enter your email" required>
            </div>
            <div class="mb-4">
                <label for="password" class="block text-sm font-medium text-gray-700">Password:</label>
                <input type="password" id="password" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Enter your password" required>
            </div>
            <button id="authenticateBtn" class="w-full bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600 transition duration-200">
                <i class="fas fa-check"></i> Authenticate
            </button>
        </div>

        <!-- Entity Selection and Fetch Buttons -->
        <div id="entityControls" class="flex justify-center gap-2 mt-4" style="display: none;">
            <!-- Facilioo Entity Section -->
            <div class="bg-white p-4 rounded border text-center">
                <label for="entitySelect" class="block text-xs font-medium text-gray-600 mb-1">Facilioo Entity</label>
                <select id="entitySelect" class="block w-full px-2 py-1 border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500 text-sm">
                    <option value="">-- Select --</option>
                </select>
                <button id="fetchEntityBtn" class="bg-blue-500 text-white w-full py-1 mt-2 rounded hover:bg-blue-600 text-sm">
                    <i class="fas fa-download"></i> Fetch to DB and Excel
                </button>
            </div>

            <!-- CRM Entity Section -->
            <div class="bg-white p-4 rounded border text-center">
                <label for="entitySelectCRM" class="block text-xs font-medium text-gray-600 mb-1">CRM Entity</label>
                <select id="entitySelectCRM" class="block w-full px-2 py-1 border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500 text-sm">
                    <option value="">-- Select --</option>
                </select>
                <button id="fetchEntityBtnCRM" class="bg-blue-500 text-white w-full py-1 mt-2 rounded hover:bg-blue-600 text-sm">
                    <i class="fas fa-download"></i> Show Fields
                </button>
            </div>
        </div>

<!-- Match Entities Button -->
<div class="text-center mt-4" id="matchControls" style="display: none;">
    <button id="matchEntitiesBtn" class="bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600 transition duration-200">
        <i class="fas fa-exchange-alt"></i> Match Entities
    </button>
</div>

        <!-- Dropdown for Matched Fields -->
        <div class="text-center mt-4" id="matchedFieldsDropdownContainer" style="display: none;">
            <label for="matchedFieldsDropdown" class="block text-sm font-medium text-gray-700">
                Select Matched Fields:
            </label>
            <select id="matchedFieldsDropdown" multiple size="6"
                class="mt-1 block w-160 mx-auto px-3 py-2 border border-gray-400 rounded-lg shadow-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                <!-- Options will be populated dynamically -->
            </select>
        </div>

        <div class="text-center mt-4" id="saveMatchingBtnContainer" style="display: none;">
            <button id="saveMatchingBtn" class="bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600 transition duration-200">
                Save Matching
            </button>
        </div>
        

        <!-- Migration Button -->
        <div id="migrationControls" class="text-center mt-8" style="display: none;">
            <button id="migrateBtn" class="bg-green-500 text-white py-2 px-4 rounded-md hover:bg-green-600 transition duration-200" style="display: none;">
                <i class="fas fa-sync-alt"></i> Start Accounts Migration
            </button>
            <button id="migrateEntityBtn" class="bg-green-500 text-white py-2 px-4 rounded-md hover:bg-green-600 transition duration-200">
                <i class="fas fa-sync-alt"></i> Migration
            </button>
        </div>



        <!-- Progress Bars -->
        <div id="progressContainer" class="mt-8 max-w-2xl mx-auto" style="display: none;">
            <h3 class="text-xl font-semibold mb-4">Migration Progress</h3>

            <!-- Fetching Users Progress -->
            <div class="mb-6">
                <div class="flex justify-between mb-2">
                    <span>Fetching</span>
                    <span id="fetchingMessage">Not Started</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div id="fetchingProgress" class="progress-bar bg-blue-500 h-2.5 rounded-full" style="width: 0%"></div>
                </div>
            </div>

            <!-- Migration Progress -->
            <div class="mb-6">
                <div class="flex justify-between mb-2">
                    <span>Migration</span>
                    <span id="migrationMessage">Not Started</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div id="migrationProgress" class="progress-bar bg-green-500 h-2.5 rounded-full" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- Logs Section -->
        <div id="logsSection" class="mt-8 max-w-2xl mx-auto" style="display: none;">
            <h3 class="text-xl font-semibold mb-4"><i class="fas fa-clipboard-list"></i> Logs</h3>
            <button id="toggleLogs" class="bg-gray-500 text-white py-1 px-3 rounded-md hover:bg-gray-600 transition duration-200">Show Logs</button>
            <div id="logsContainer" class="mt-4 bg-white p-4 rounded-lg shadow-md" style="display: none; max-height: 300px; overflow-y: auto;"></div>
        </div>

        <!-- Migration Summary Table -->
        <div id="migrationSummary" class="mt-8 max-w-2xl mx-auto" style="display: none;">
            <h3 class="text-xl font-semibold mb-4"><i class="fas fa-table"></i> Migration Summary</h3>
            <div class="bg-white p-4 rounded-lg shadow-md overflow-x-auto">
                <table id="migrationSummaryTable" class="w-full">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="px-4 py-2">Entity</th>
                            <th class="px-4 py-2">Source Records</th>
                            <th class="px-4 py-2">Processed Records</th>
                            <th class="px-4 py-2">Created</th>
                            <th class="px-4 py-2">Updated</th>
                            <th class="px-4 py-2">Errors</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Rows will be populated dynamically -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Excel Download Link -->
        <div id="excelDownload" class="mt-8 max-w-2xl mx-auto text-center" style="display: none;">
            <a id="excelLink" href="#" download class="text-blue-500 hover:text-blue-600">
                <i class="fas fa-file-excel"></i> Download Excel Export
            </a>
        </div>

        <!-- CRM Link -->
        <div id="crmLinkContainer" class="mt-8 max-w-2xl mx-auto text-center" style="display: none;">
            <a id="crmLink" href="#" class="text-blue-500 hover:text-blue-600">Go to CRM Contacts</a>
        </div>

        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50" style="display: none;">
            <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"></div>
        </div>
    </div>

    <script>
        let accessToken = null;

        $(document).ready(function () {

            let isDropdownChanged = false; // Flag to track dropdown changes
            const saveMatchingBtn = $("#saveMatchingBtn");
            saveMatchingBtn.hide();
            const migrateEntityBtn = $("#migrateEntityBtn");
            migrateEntityBtn.hide();

            $("#matchedFieldsDropdown").select2({
                placeholder: "Select matched fields",
                allowClear: true,
                width: "50%"
            });

            $("#matchedFieldsDropdown").on("change", function () {
                $("#saveMatchingBtnContainer").toggle($(this).val().length > 0);
                isDropdownChanged = true; // Set the flag to true when dropdown changes
                saveMatchingBtn.show(); // Show the Save Matching button

            });

            $("#matchedFieldsDropdown").on("select2:select", function (e) {
                $(".select2-selection__choice").css("background-color", "");
                $(".select2-selection__choice").first().css("background-color", "yellow");
                $("#matchedFieldsDropdown option").css("background-color", "");
                $("#matchedFieldsDropdown option:selected").first().css("background-color", "yellow");
            });
        
            $("#matchedFieldsDropdown").on("select2:unselect", function (e) {
                $(".select2-selection__choice").css("background-color", "");
                $(".select2-selection__choice").first().css("background-color", "yellow");
                $("#matchedFieldsDropdown option").css("background-color", "");
                $("#matchedFieldsDropdown option:selected").first().css("background-color", "yellow");
            });

            $("#saveMatchingBtn").on("click", async function () {
                const selectedFaciliooEntity = $("#entitySelect").val();
                const selectedCrmEntity = $("#entitySelectCRM").val();
                const selectedFields = $("#matchedFieldsDropdown").val();
                const logsContainer = document.getElementById("logsContainer");
                if (!selectedFaciliooEntity || !selectedCrmEntity) {logsContainer.innerHTML += `<p style="color: red;">‚ùå Please select both Facilioo and CRM entities.</p>`;autoScrollLogs();return;}            
                if (!selectedFields || selectedFields.length === 0) {logsContainer.innerHTML += `<p style="color: red;">‚ùå Please select at least one matched field.</p>`;autoScrollLogs();return;}
                const nonEmptyFields = selectedFields.filter(field => field && field.trim());
                if (nonEmptyFields.length === 0) {logsContainer.innerHTML += `<p style="color: red;">‚ùå Please select at least one valid matched field.</p>`;autoScrollLogs();return;}
                const payload = {
                    selectedFaciliooEntity,
                    selectedCrmEntity,
                    matchedFields: nonEmptyFields
                };
                logsContainer.innerHTML += `<p>üì§ Sending payload: ${JSON.stringify(payload)}</p>`;            
                autoScrollLogs();            
                document.getElementById("migrationSummary").style.display = "none";
                try {
                    const response = await fetch("/save-matching-columns", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": `Bearer ${accessToken}`
                        },
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();
                    if (response.ok) {
                        logsContainer.innerHTML += `<p style="color: green;">‚úÖ ${result.message}</p>`;autoScrollLogs();
                        migrateEntityBtn.show();
                    } else {logsContainer.innerHTML += `<p style="color: red;">‚ùå Error: ${result.detail}</p>`;autoScrollLogs();
                    }
                    isDropdownChanged = false;
                    saveMatchingBtn.hide();
                    matchedFieldsDropdownContainer.style.display = "none";
                    migrateEntityBtn.show();

        

                } catch (error) {
                    console.error("Error saving matching columns:", error);
                    logsContainer.innerHTML += `<p style="color: red;">‚ùå An error occurred while saving matching columns.</p>`;autoScrollLogs();
                }
            });
                        


            async function fetchAndDisplayMatchingFields() {
                const selectedFaciliooEntity = $("#entitySelect").val();
                const selectedCrmEntity = $("#entitySelectCRM").val();
                const logsContainer = document.getElementById("logsContainer");
                const migrateEntityBtn = $("#migrateEntityBtn");
                const matchedFieldsDropdownContainer = document.getElementById("matchedFieldsDropdownContainer");
                const matchedFieldsDropdown = document.getElementById("matchedFieldsDropdown");
                document.getElementById("migrationSummary").style.display = "none";
                if (!selectedFaciliooEntity || !selectedCrmEntity) {
                    logsContainer.innerHTML = `<strong>Please select both entities to compare.</strong>`;
                    return;
                }
            
                try {
                    $("#logsContainer").show();
                    const response = await fetch(`/get-matching-fields?selectedFaciliooEntity=${selectedFaciliooEntity}&selectedCrmEntity=${selectedCrmEntity}`, {
                        method: "GET",
                        headers: { "Authorization": `Bearer ${accessToken}` }
                    });
                    const result = await response.json();
            
                    if (response.ok) {
                        const matchedFields = result.matched_fields || [];
            
                        if (matchedFields.length > 0) {
                            // Show the dropdown and populate it with matched fields
                            matchedFieldsDropdown.innerHTML = ""; // Clear existing options
                            matchedFields.forEach(match => {
                                const [faciliooField, crmField] = match.split("-");
                                const option = document.createElement("option");
                                option.value = match;
                                option.textContent = `${faciliooField} - ${crmField}`;
                                //matchedFieldsDropdown.appendChild(option);
                                matchedFieldsDropdown.prepend(option);  
                            });
                            matchedFieldsDropdownContainer.style.display = "none"; // Hide the dropdown container

                            // Display the table with matched fields
                            let tableHTML = `
                                <strong>Comparing:</strong> 
                                <br>Facilioo Entity: <b>${selectedFaciliooEntity}</b> 
                                <br>CRM Entity: <b>${selectedCrmEntity}</b>
                                <hr>
                                <table border="1" cellspacing="0" cellpadding="5" style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="background-color: #f2f2f2;">
                                            <th>Facilioo Entity</th>
                                            <th>CRM Entity</th>
                                        </tr>
                                    </thead>
                                    <tbody>`;
            
                            matchedFields.forEach(match => {
                                const [faciliooField, crmField] = match.split("-");
                                tableHTML += `
                                    <tr>
                                        <td>${faciliooField}</td>
                                        <td>${crmField}</td>
                                    </tr>`;
                            });
            
                            tableHTML += `</tbody></table>`;
                            logsContainer.innerHTML = tableHTML;
                            migrateEntityBtn.show();
                        } else {
                            // Hide the dropdown and display a message
                            matchedFieldsDropdownContainer.style.display = "none"; // Hide the dropdown container
                            logsContainer.innerHTML = `
                                <strong>Comparing:</strong> 
                                <br>Facilioo Entity: <b>${selectedFaciliooEntity}</b> 
                                <br>CRM Entity: <b>${selectedCrmEntity}</b>
                                <hr>
                                No matching fields found.
                            `;
                            migrateEntityBtn.hide();
                        }
            
                        autoScrollLogs();
                    } else {
                        alert(`Error: ${result.detail}`);
                    }
                } catch (error) {
                    console.error("Error fetching matching fields:", error);
                }
            }
            
            $("#entitySelect, #entitySelectCRM").on("change", fetchAndDisplayMatchingFields);

            document.getElementById("matchEntitiesBtn").addEventListener("click", async () => {
                const faciliooEntitySelect = document.getElementById("entitySelect");
                const crmEntitySelect = document.getElementById("entitySelectCRM");
                const selectedFaciliooEntity = faciliooEntitySelect.value;
                const selectedCrmEntity = crmEntitySelect.value;
            
                if (!selectedFaciliooEntity || !selectedCrmEntity) {
                    alert("Please select both Facilioo and CRM entities.");
                    return;
                }
                const logsContainer = document.getElementById("logsContainer");
                logsContainer.innerHTML = `<p><i class="fas fa-info-circle"></i> Matching entities: ${selectedFaciliooEntity} and ${selectedCrmEntity}...</p>`;
                autoScrollLogs();
                logsContainer.style.display = "block";
                document.getElementById("migrationSummary").style.display = "none";
                showLoadingSpinner();
                try {
                    // Fetch entity fields and matched fields
                    const [faciliooResponse, crmResponse, matchedFieldsResponse] = await Promise.all([
                        fetch(`/fetch-entity-fields?entity_name=${selectedFaciliooEntity}`, {
                            method: "POST",
                            headers: {
                                "Authorization": `Bearer ${accessToken}`,
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({ entity_name: selectedFaciliooEntity })
                        }),
                        fetch(`/crm-entity-fields?entity_name=${selectedCrmEntity}`, {
                            method: "GET",
                            headers: {
                                "Authorization": `Bearer ${accessToken}`,
                                "Content-Type": "application/json",
                            },
                        }),
                        fetch(`/get-matching-fields?selectedFaciliooEntity=${selectedFaciliooEntity}&selectedCrmEntity=${selectedCrmEntity}`, {
                            method: "GET",
                            headers: {
                                "Authorization": `Bearer ${accessToken}`,
                            },
                        }),
                    ]);
            
                    if (!faciliooResponse.ok || !crmResponse.ok || !matchedFieldsResponse.ok) {
                        throw new Error("Failed to fetch entity fields or matched fields.");
                    }
            
                    const faciliooData = await faciliooResponse.json();
                    const crmData = await crmResponse.json();
                    const matchedFieldsData = await matchedFieldsResponse.json();
            
                    if (faciliooData.success && crmData.success && matchedFieldsData.success) {
                        const faciliooFields = faciliooData.columns;
                        const crmFields = crmData.columns;
                        const existingMatchedFields = matchedFieldsData.matched_fields || [];
            
                        const isEntirelyPartOf = (field1, field2) => {
                            const lowerField1 = field1.toLowerCase();
                            const lowerField2 = field2.toLowerCase();
                            return lowerField2.includes(lowerField1) || lowerField1.includes(lowerField2);
                        };
            
                        const matchedFields = [];
                        const uniqueFaciliooFields = [];
                        const uniqueCrmFields = [];

                        faciliooFields.forEach(faciliooField => {
                            let isMatched = false;
                            crmFields.forEach(crmField => {
                                if (faciliooField.toLowerCase() === crmField.toLowerCase()) {
                                    // 100% match
                                    matchedFields.push({ faciliooField, crmField, isExactMatch: true });
                                    isMatched = true;
                                } else if (isEntirelyPartOf(faciliooField, crmField)) {
                                    matchedFields.push({ faciliooField, crmField, isExactMatch: false });
                                    isMatched = true;
                                }
                            });
                            if (!isMatched) {
                                uniqueFaciliooFields.push(faciliooField); // Unique to Facilioo
                            }
                        });
            
                        crmFields.forEach(crmField => {
                            if (!faciliooFields.some(faciliooField => 
                                faciliooField.toLowerCase() === crmField.toLowerCase() || 
                                isEntirelyPartOf(faciliooField, crmField))
                            ) {
                                uniqueCrmFields.push(crmField);
                            }
                        });
            
                        // Render the table (unchanged)
                        let tableHtml = `<table style="width: 100%; border-collapse: collapse; table-layout: fixed; font-size: 12px; line-height: 1.2;">
                                            <tr>
                                                <th style="padding: 4px; text-align: left; background-color: #f4f4f4; font-weight: normal;">Facilioo Fields</th>
                                                <th style="padding: 4px; text-align: left; background-color: #f4f4f4; font-weight: normal;">CRM Fields</th>
                                                <th style="padding: 4px; text-align: left; background-color: #f4f4f4; font-weight: normal;">Matched Fields</th>
                                            </tr>`;
                        const maxLength = Math.max(uniqueFaciliooFields.length, uniqueCrmFields.length, matchedFields.length);
                        for (let i = 0; i < maxLength; i++) {
                            tableHtml += "<tr>";
                            const faciliooField = uniqueFaciliooFields[i];
                            tableHtml += `<td style="padding: 4px; border: 1px solid #ddd; overflow: hidden; text-overflow: ellipsis;">${
                                faciliooField ? `<span style="color: magenta;">‚úò ${faciliooField}</span>` : ''
                            }</td>`;
                            const crmField = uniqueCrmFields[i];
                            tableHtml += `<td style="padding: 4px; border: 1px solid #ddd; overflow: hidden; text-overflow: ellipsis;">${
                                crmField ? `<span style="color: blue;">‚úò ${crmField}</span>` : ''
                            }</td>`;
                            const matchedField = matchedFields[i];
                            tableHtml += `<td style="padding: 4px; border: 1px solid #ddd; overflow: hidden; text-overflow: ellipsis;">${
                                matchedField ? 
                                    (matchedField.isExactMatch ? 
                                        `<span style="color: green; font-weight: bold;">‚úî ${matchedField.faciliooField}</span>` : 
                                        `<span style="color: magenta;">${matchedField.faciliooField}</span> - <span style="color: blue;">${matchedField.crmField}</span>`) : 
                                    ''
                            }</td>`;
                            tableHtml += "</tr>";
                        }
                        tableHtml += "</table>";
                        logsContainer.innerHTML += tableHtml;
                        autoScrollLogs();

                        // Populate the dropdown with matched fields
                        const matchedFieldsDropdown = document.getElementById("matchedFieldsDropdown");
                        matchedFieldsDropdown.innerHTML = ""; // Clear existing options
                        matchedFields.forEach(matchedField => {
                            const option = document.createElement("option");
                            option.value = `${matchedField.faciliooField}-${matchedField.crmField}`;
                            option.textContent = matchedField.isExactMatch ? 
                                `‚úî ${matchedField.faciliooField}` : 
                                `${matchedField.faciliooField} - ${matchedField.crmField}`;
            
                            // Mark the option as selected if it exists in the existingMatchedFields
                            if (existingMatchedFields.includes(`${matchedField.faciliooField}-${matchedField.crmField}`)) {
                                option.selected = true;
                            }
            
                            //matchedFieldsDropdown.appendChild(option);
                            matchedFieldsDropdown.prepend(option);

                        });
            
                        // Show the dropdown container only if there are matched fields
                        const matchedFieldsDropdownContainer = document.getElementById("matchedFieldsDropdownContainer");
                        if (matchedFields.length > 0) {
                            matchedFieldsDropdownContainer.style.display = "block";
                        } else {
                            matchedFieldsDropdownContainer.style.display = "none";
                        }
                    } else {
                        logsContainer.innerHTML += `<p><i class="fas fa-times-circle"></i> Failed to fetch entity fields.</p>`;
                        autoScrollLogs();
                    }
                } catch (error) {
                    console.error("Error:", error);
                    logsContainer.innerHTML += `<p><i class="fas fa-times-circle"></i> An error occurred while matching entities.</p>`;
                    autoScrollLogs();
                }
                hideLoadingSpinner();
            });        
        



// do not delete });               

    });
        

        document.getElementById("toggleLogs").addEventListener("click", function() {
            const logsContainer = document.getElementById("logsContainer");
            logsContainer.style.display = logsContainer.style.display === "none" ? "block" : "none";
            this.textContent = logsContainer.style.display === "none" ? "Show Logs" : "Hide Logs";
        });


        document.getElementById("migrateEntityBtn").addEventListener("click", async () => {
            const logsContainer = document.getElementById("logsContainer");
            logsContainer.innerHTML = "";
            logsContainer.style.display = "block";
            document.getElementById("migrationSummary").style.display = "none";
            resetProgressBars();
            showLoadingSpinner();
        
            try {
                const selectedFaciliooEntity = $("#entitySelect").val();  // Get selected Facilioo entity
                const selectedCrmEntity = $("#entitySelectCRM").val();    // Get selected CRM entity
        
                // Log start of migration
                logsContainer.innerHTML += `<p><i class="fas fa-info-circle"></i> Starting migration for Facilioo entity: <b>${selectedFaciliooEntity}</b> to CRM entity: <b>${selectedCrmEntity}</b>...</p>`;
                
                const fetchingMessageElement = document.querySelector("#fetchingMessage");
                if (fetchingMessageElement) {
                    fetchingMessageElement.textContent = "Fetching ...";
                } else {
                    console.error('Fetching message element not found');
                }
                document.getElementById("fetchingProgress").style.width = "50%";
        
                // Fetch matched fields for the selected entities
                const matchedFieldsResponse = await fetch(`/get-matching-fields?selectedFaciliooEntity=${selectedFaciliooEntity}&selectedCrmEntity=${selectedCrmEntity}`, {
                    method: "GET",
                    headers: {"Authorization": `Bearer ${accessToken}`}
                });
        
                if (!matchedFieldsResponse.ok) {
                    throw new Error("Failed to fetch matched fields.");
                }
        
                const matchedFieldsData = await matchedFieldsResponse.json();
                const matchedFields = matchedFieldsData.matched_fields;
        
                if (!matchedFields || matchedFields.length === 0) {
                    throw new Error("No matching fields found for the selected entities.");
                }
        
                // Log matched fields
                logsContainer.innerHTML += `<p><i class="fas fa-check-circle"></i> Retrieved matched fields for migration.</p>`;
                document.getElementById("fetchingProgress").style.width = "100%";
                document.getElementById("fetchingMessage").textContent = "Complete";
        
                // Fetch entity data from staging
                logsContainer.innerHTML += `<p><i class="fas fa-info-circle"></i> Retrieving data for Facilioo entity: <b>${selectedFaciliooEntity}</b> from staging database...</p>`;
                const entityDataResponse = await fetch(`/get-entity-data?entity_name=${selectedFaciliooEntity}`, {
                    method: "GET",
                    headers: {"Authorization": `Bearer ${accessToken}`}
                });
        
                if (!entityDataResponse.ok) {
                    throw new Error("Failed to fetch entity data from staging.");
                }
        
                const entityData = await entityDataResponse.json();
        
                // Check the structure of entityData to find the number of records
                const totalRecords = entityData.total_records || entityData.data?.length || entityData.length || 0;
        
                logsContainer.innerHTML += `<p><i class="fas fa-check-circle"></i> Retrieved ${totalRecords} records for Facilioo entity: <b>${selectedFaciliooEntity}</b>.</p>`;
        
                // Start migration
                document.getElementById("migrationMessage").textContent = "Starting migration...";
                document.getElementById("migrationProgress").style.width = "0%";
        
                const response = await fetch("/migrate-entity", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({
                        selected_facilioo_entity: selectedFaciliooEntity,
                        selected_crm_entity: selectedCrmEntity
                    }),
                });
        
                if (!response.ok) {
                    throw new Error("Migration failed.");
                }
        
                const data = await response.json();
                const totalMigratedRecords = data.total_records;
                let processedRecords = 0;
        
                // Process migration results
                for (const result of data.results) {
                    processedRecords++;
                    const progress = (processedRecords / totalMigratedRecords) * 100;
                    document.getElementById("migrationProgress").style.width = `${progress}%`;
                    document.getElementById("migrationMessage").textContent = `Migrating record ${result.record_id}...`;
        
                    // Log the current record being processed
                    logsContainer.innerHTML += `
                        <p>
                            <i class="fas fa-sync-alt"></i> Processing record <b>${processedRecords}</b> of <b>${totalMigratedRecords}</b>...
                            <br>
                            <strong>Record ID:</strong> ${result.record_id} <br>
                            <strong>Staging Status:</strong> ${result.staging_status} <br>
                            <strong>CRM Status:</strong> ${result.crm_status} <br>
                            <strong>Action:</strong> ${result.action || "none"} <br>
                            ${result.error ? `<strong>Error:</strong> ${result.error}` : ""}
                            ${result.failed_fields ? `<strong>Failed Fields:</strong> ${result.failed_fields.join(", ")}` : ""}
                        </p>
                    `;
                    autoScrollLogs();
                    await new Promise(resolve => setTimeout(resolve, 100)); // 100ms delay
                }
        
                // Log migration summary
                logsContainer.innerHTML += `
                    <p><i class="fas fa-info-circle"></i> Migration Summary:</p>
                    <p>Total Records: ${totalMigratedRecords}</p>
                    <p>Successfully Migrated: ${data.success_count}</p>
                    <p>Updated: ${data.update_count}</p>
                    <p>Inserted: ${data.insert_count}</p>
                    <p>Failed: ${data.error_count}</p>
                `;
                autoScrollLogs();
        
                // Update migration summary table
                const summaryTable = document.getElementById("migrationSummaryTable").getElementsByTagName('tbody')[0];
                summaryTable.innerHTML = `
                    <tr>
                        <td class="px-4 py-2">${data.entity_name}</td>
                        <td class="px-4 py-2">${totalMigratedRecords}</td>
                        <td class="px-4 py-2">${data.success_count + data.error_count}</td>
                        <td class="px-4 py-2">${data.insert_count}</td>
                        <td class="px-4 py-2">${data.update_count}</td>
                        <td class="px-4 py-2">${data.error_count}</td>
                    </tr>
                `;
        
                // Show the migration summary table
                document.getElementById("migrationSummary").style.display = "block";
        
                // Handle Excel download link
                if (data.excel_file_url) {
                    const excelLink = document.getElementById("excelLink");
                    excelLink.href = data.excel_file_url;
                    document.getElementById("excelDownload").style.display = "block";
                }
        
                // Update migration status message
                if (data.error_count === 0) {
                    document.getElementById("migrationMessage").textContent = "Complete";
                } else {
                    document.getElementById("migrationMessage").textContent = "Partial Success";
                }
        
                setTimeout(resetProgressBars, 1000);
            } catch (error) {
                console.error("Error:", error);
                logsContainer.innerHTML += `<p><i class="fas fa-times-circle"></i> An error occurred during migration: ${error.message}</p>`;
                document.getElementById("fetchingMessage").textContent = "Fetching: Error";
                document.getElementById("migrationMessage").textContent = "Migration: Error";
            } finally {
                hideLoadingSpinner();
            }
        });

        function autoScrollLogs() {
            const logsContainer = document.getElementById("logsContainer");
            logsContainer.scrollTop = logsContainer.scrollHeight; // Scroll to the bottom
        }

        document.getElementById("authenticateBtn").addEventListener("click", async () => {
            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;
            if (!email || !password) {
                alert("Please enter both email and password.");
                return;
            }
            showLoadingSpinner();
            try {
                const response = await fetch("/authenticate", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ email, password }),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || "Authentication failed.");
                }

                const data = await response.json();
                accessToken = data.access_token; // Store token globally
                document.getElementById("authForm").style.display = "none";
                document.getElementById("migrationControls").style.display = "block";
                document.getElementById("matchControls").style.display = "block";
                document.getElementById("progressContainer").style.display = "block";
                document.getElementById("logsSection").style.display = "block";
                document.getElementById("entityControls").style.display = "flex";
                await fetchAndPopulateCrmEntities();
            } catch (error) {
                console.error("Error during authentication:", error);
                alert(`Authentication failed: ${error.message}`);
            } finally {hideLoadingSpinner();}
        });

       async function fetchAndPopulateCrmEntities() {
        try {
            const response = await fetch("/crm-entities", {
                method: "GET",
                headers: {
                    "Authorization": `Bearer ${accessToken}`,
                    "Content-Type": "application/json"
                }
            });

            if (!response.ok) {
                throw new Error("Failed to fetch CRM entities");}
            const data = await response.json();
            if (!data.entities || !Array.isArray(data.entities)) {throw new Error("Invalid API response format");}
            const entitySelectCRM = document.getElementById("entitySelectCRM");
            entitySelectCRM.innerHTML = '<option value="">-- Select a CRM Entity --</option>';
            data.entities.forEach(entity => {
                const option = document.createElement("option");
                option.value = entity;
                option.textContent = entity.replace(/-/g, " "); // Replace hyphens with spaces
                entitySelectCRM.appendChild(option);
            });
            console.log("CRM entities loaded successfully.");
        } catch (error) {
            console.error("Error fetching CRM entities:", error);
            alert("Failed to fetch CRM entities. Please try again.");
        }
    }

        // Fetch and populate Facilioo entities dropdown
        async function populateEntityDropdown() {
            try {
                const response = await fetch("/facilioo-entities");
                if (!response.ok) {throw new Error("Failed to fetch entities list");}
                const entities = await response.json();
                const entitySelect = document.getElementById("entitySelect");
                document.getElementById("migrationSummary").style.display = "none";
                entitySelect.innerHTML = '<option value="">-- Select a Facilioo Entity --</option>';
                entities.forEach(entity => {
                    const option = document.createElement("option");
                    option.value = entity;
                    option.textContent = entity.replace(/-/g, " "); 
                    entitySelect.appendChild(option);
                });
            } catch (error) {
                console.error("Error fetching entities list:", error);
                alert("Failed to fetch Facilioo entities. Please try again.");
            }
        }

    
    
    document.addEventListener("DOMContentLoaded", () => {
            if (accessToken) {fetchAndPopulateCrmEntities();}
        });


        async function fetchEntitiesList() {
            try {
                const response = await fetch("/facilioo-entities");
                if (!response.ok) {
                    throw new Error("Failed to fetch entities list");
                }
                const entities = await response.json();
                return entities;
            } catch (error) {
                console.error("Error fetching entities list:", error);
                return []; // Return an empty array or handle the error as needed
            }

        }

        
        // Fetch data for the selected entity
        async function fetchEntityData(entityName) {
            try {
                const response = await fetch(`/fetch-and-save-entity?entity_name=${entityName}`, {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${accessToken}`,
                        "Content-Type": "application/json",
                    },
                });
                if (!response.ok) {throw new Error("Failed to fetch entity data");}
                const data = await response.json();return data;
            } catch (error) {console.error("Error fetching entity data:", error);throw error;}
        }


        document.getElementById("fetchEntityBtnCRM").addEventListener("click", async () => {
            const entitySelect = document.getElementById("entitySelectCRM");
            const selectedEntity = entitySelect.value;
            if (!selectedEntity) {alert("Please select a CRM entity.");return;}
            const logsContainer = document.getElementById("logsContainer");
            logsContainer.innerHTML = `<p><i class="fas fa-info-circle"></i> Fetching column names for CRM entity: ${selectedEntity}...</p>`;
            autoScrollLogs();
            logsContainer.style.display = "block";
            try {
                const response = await fetch(`/crm-entity-fields?entity_name=${selectedEntity}`, {
                    method: "GET",
                    headers: {
                        "Authorization": `Bearer ${accessToken}`,
                        "Content-Type": "application/json",
                    },
                });
                if (!response.ok) {throw new Error("Failed to fetch CRM entity fields");}
                const data = await response.json();
                if (data.success) {
                    logsContainer.innerHTML += `<p><i class="fas fa-list"></i> Entity Columns:</p>`;
                    logsContainer.innerHTML += `<pre>${data.columns.join("\n")}</pre>`; // Display columns in the logs section
                    autoScrollLogs();
                } else {logsContainer.innerHTML += `<p><i class="fas fa-times-circle"></i> Failed to fetch columns for ${selectedEntity}.</p>`;autoScrollLogs();}
            } catch (error) {
                console.error("Error:", error);
                logsContainer.innerHTML += `<p><i class="fas fa-times-circle"></i> An error occurred while fetching columns for ${selectedEntity}.</p>`;
                autoScrollLogs();
            }
        });

            // Event listener for the "Fetch Entity Data" button
            document.getElementById("fetchEntityBtn").addEventListener("click", async () => {
                const entitySelect = document.getElementById("entitySelect");
                const selectedEntity = entitySelect.value;
                const logsContainer = document.getElementById("logsContainer");

                if (!selectedEntity) {
                    alert("Please select an entity.");
                    return;
                }

                showLoadingSpinner();
                logsContainer.innerHTML = "";
                logsContainer.style.display = "block";
                document.getElementById("migrationSummary").style.display = "none";

                logsContainer.innerHTML += `<p><i class="fas fa-info-circle"></i> Fetching data for entity: ${selectedEntity}...</p>`;
                autoScrollLogs();

                try {
                    // Real-time progress tracking for fetching data
                    document.getElementById("fetchingMessage").textContent = `Fetching ${selectedEntity}...`;
                    document.getElementById("fetchingProgress").style.width = "0%";

                    const eventSource = new EventSource(`/stream-progress?entity_name=${selectedEntity}`);
                    eventSource.onmessage = function (event) {
                        const progress = parseInt(event.data);
                        document.getElementById("fetchingProgress").style.width = `${progress}%`;
                        document.getElementById("fetchingMessage").textContent = `Fetching ${selectedEntity}... ${progress}%`;

                        if (progress === 100) {
                            eventSource.close();
                            logsContainer.innerHTML += `<p><i class="fas fa-check-circle"></i> Data fetched successfully for ${selectedEntity}.</p>`;
                            autoScrollLogs();
                            fetchTotalRows(selectedEntity);

                            setTimeout(() => {
                                document.getElementById("fetchingProgress").style.width = "0%";
                                document.getElementById("fetchingMessage").textContent = "Not Started";
                            }, 1000);
                        }
                    };

                    // Step 1: Fetch & save entity data
                    const fetchResponse = await fetch(`/fetch-and-save-entity?entity_name=${selectedEntity}`, {
                        method: "POST",
                        headers: {
                            "Authorization": `Bearer ${accessToken}`,
                            "Content-Type": "application/json",
                        },
                    });

                    if (!fetchResponse.ok) throw new Error("Failed to fetch entity data");

                    const fetchData = await fetchResponse.json();
                    if (fetchData.success) {
                        logsContainer.innerHTML += `<p><i class="fas fa-list"></i> Entity Columns:</p>`;
                        logsContainer.innerHTML += `<pre>${fetchData.columns.join("\n")}</pre>`;
                        autoScrollLogs();
                    } else {
                        throw new Error(`Failed to fetch and save data for ${selectedEntity}`);
                    }

                    // Step 2: Fetch & export entity data (only after fetch-and-save is successful)
                    logsContainer.innerHTML += `<p><i class="fas fa-info-circle"></i> Exporting data for entity: ${selectedEntity}...</p>`;
                    autoScrollLogs();

                    const exportResponse = await fetch("/fetch-and-export/", {
                        method: "POST",
                        headers: {
                            "Authorization": `Bearer ${accessToken}`,
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({ entity_name: selectedEntity }),
                    });

                    if (!exportResponse.ok) throw new Error("Failed to export entity data");

                    const exportData = await exportResponse.json();
                    if (exportData.success) {
                        // Update the Excel download link
                        if (exportData.excel_file_url) {
                            const excelLink = document.getElementById("excelLink");
                            excelLink.href = exportData.excel_file_url;
                        }

                        logsContainer.innerHTML += `<p><i class="fas fa-file-excel"></i> <a id="excelLink" href="${exportData.excel_file_url}" target="_blank">Download Excel File</a></p>`;
                        logsContainer.innerHTML += `<p><i class="fas fa-list"></i> Entity Columns:</p>`;
                        logsContainer.innerHTML += `<pre>${exportData.columns.join("\n")}</pre>`;
                        document.getElementById("excelDownload").style.display = "block";

                        autoScrollLogs();
                    } else {
                        throw new Error(`Failed to export data for ${selectedEntity}`);
                    }

                } catch (error) {
                    logsContainer.innerHTML += `<p><i class="fas fa-times-circle"></i> Error: ${error.message}</p>`;
                    autoScrollLogs();
                } finally {
                    hideLoadingSpinner();
                }
            });



        async function fetchTotalRows(entityName) {
            try {
                const response = await fetch(`/get-total-rows?entity_name=${entityName}`, {
                    method: "GET",
                    headers: {
                        "Authorization": `Bearer ${accessToken}`,
                    },
                });

                if (!response.ok) {
                    throw new Error("Failed to fetch total rows.");
                }

                const data = await response.json();
                const logsContainer = document.getElementById("logsContainer");
                logsContainer.innerHTML += `<p><i class="fas fa-database"></i> Total rows fetched for ${entityName}: ${data.total_records}</p>`;
                autoScrollLogs();
            } catch (error) {
                console.error("Error fetching total rows:", error);
                const logsContainer = document.getElementById("logsContainer");
                logsContainer.innerHTML += `<p><i class="fas fa-times-circle"></i> Failed to fetch total rows for ${entityName}.</p>`;
                autoScrollLogs();
            }
        }

        document.addEventListener("DOMContentLoaded", () => {populateEntityDropdown();});
        async function fetchAndSaveUsers(accessToken) {
            try {
                const response = await fetch("/fetch-and-save-users", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${accessToken}`,
                    },
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Failed to fetch and save users');
                }
                const data = await response.json();return data;
            } catch (error) {
                console.error("Error during fetch and save users:", error);
                throw new Error(error.message || 'Error fetching and saving users');
            }
        }

        async function getCrmContactsUrl() {
            try {
                const response = await fetch('/api/crm-contacts-url');
                if (!response.ok) {throw new Error('Failed to fetch CRM contacts URL');}
                const data = await response.json();
                return data.crmContactsUrl;
            } catch (error) {console.error('Error fetching CRM contacts URL:', error);return null;}
        }
        function resetProgressBars() {
            document.getElementById("fetchingProgress").style.width = "0%";
            document.getElementById("migrationProgress").style.width = "0%";
            document.getElementById("fetchingMessage").textContent = "Fetching : Not Started";
            document.getElementById("migrationMessage").textContent = "Migration: Not Started";
            document.getElementById("fetchingMessage").textContent = "Pending";
            document.getElementById("migrationMessage").textContent = "Pending";
        }
        function showLoadingSpinner() {
            $("#loadingSpinner").show(); 
        }
        
        function hideLoadingSpinner() {
            $("#loadingSpinner").hide();
        }

    </script>
</body>
</html>